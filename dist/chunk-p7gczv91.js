import{d as a,g as n}from"/dist/chunk-9xt68df4.js";function s(){return n("div",{class:"markdown-body",children:n(a,{children:[n("p",{children:["针对你的需求，我为你设计了一个基于 ",n("strong",{children:"Spring Boot + Redis + Apache HttpClient 4 (SSE 流式处理) + ThreadPoolExecutor"},void 0,!1,void 0,this)," 的完整架构方案。"]},void 0,!0,void 0,this),`
`,n("p",{children:"这个方案解决了你担心的资源占用问题，同时通过持久化和线程池化保证了系统的健壮性。"},void 0,!1,void 0,this),`
`,n("h3",{children:"1. 整体架构流程图"},void 0,!1,void 0,this),`
`,n("ol",{children:[`
`,n("li",{children:[n("strong",{children:"Web端"},void 0,!1,void 0,this),"：发送 ",n("code",{children:"POST /api/task"},void 0,!1,void 0,this),"。"]},void 0,!0,void 0,this),`
`,n("li",{children:[n("strong",{children:"Java Service"},void 0,!1,void 0,this),"："]},void 0,!0,void 0,this),`
`]},void 0,!0,void 0,this),`
`,n("ul",{children:[`
`,n("li",{children:["生成 ",n("code",{children:"taskId"},void 0,!1,void 0,this),"。"]},void 0,!0,void 0,this),`
`,n("li",{children:["将任务状态（Pending）和初始参数存入 ",n("strong",{children:"Redis"},void 0,!1,void 0,this),"。"]},void 0,!0,void 0,this),`
`,n("li",{children:["将任务提交到",n("strong",{children:"自定义线程池"},void 0,!1,void 0,this),"。"]},void 0,!0,void 0,this),`
`,n("li",{children:["立即返回 ",n("code",{children:"taskId"},void 0,!1,void 0,this)," 给前端。"]},void 0,!0,void 0,this),`
`]},void 0,!0,void 0,this),`
`,n("ol",{start:"3",children:[`
`,n("li",{children:[n("strong",{children:"后台线程池"},void 0,!1,void 0,this),"："]},void 0,!0,void 0,this),`
`]},void 0,!0,void 0,this),`
`,n("ul",{children:[`
`,n("li",{children:"执行任务，更新 Redis 状态（Running）。"},void 0,!1,void 0,this),`
`,n("li",{children:"使用 HttpClient 4 发起 SSE 请求。"},void 0,!1,void 0,this),`
`,n("li",{children:[n("strong",{children:"逐行读取"},void 0,!1,void 0,this)," LLM 返回的流数据，并实时追加到 Redis 中。"]},void 0,!0,void 0,this),`
`,n("li",{children:"任务结束，更新状态（Success/Failed）。"},void 0,!1,void 0,this),`
`]},void 0,!0,void 0,this),`
`,n("ol",{start:"4",children:[`
`,n("li",{children:[n("strong",{children:"Web端轮询"},void 0,!1,void 0,this),"：发送 ",n("code",{children:"GET /api/task/{taskId}"},void 0,!1,void 0,this),"，从 Redis 获取最新状态和部分/全部结果。"]},void 0,!0,void 0,this),`
`]},void 0,!0,void 0,this),`
`,n("hr",{},void 0,!1,void 0,this),`
`,n("h3",{children:"2. 核心代码实现"},void 0,!1,void 0,this),`
`,n("h4",{children:"第一步：配置自定义线程池与 HttpClient"},void 0,!1,void 0,this),`
`,n("p",{children:"为了防止 20 分钟的长连接导致线程耗尽，我们需要严格控制线程池。"},void 0,!1,void 0,this),`
`,n("pre",{className:"shiki github-dark",style:{backgroundColor:"#24292e",color:"#e1e4e8"},tabIndex:"0",children:n("code",{children:[n("span",{className:"line",children:[n("span",{style:{color:"#E1E4E8"},children:"@"},void 0,!1,void 0,this),n("span",{style:{color:"#F97583"},children:"Configuration"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#F97583"},children:"public"},void 0,!1,void 0,this),n("span",{style:{color:"#F97583"},children:" class"},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:" AsyncConfig"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:" {"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line"},void 0,!1,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#E1E4E8"},children:"    @"},void 0,!1,void 0,this),n("span",{style:{color:"#F97583"},children:"Bean"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"("},void 0,!1,void 0,this),n("span",{style:{color:"#79B8FF"},children:"name"},void 0,!1,void 0,this),n("span",{style:{color:"#F97583"},children:" ="},void 0,!1,void 0,this),n("span",{style:{color:"#9ECBFF"},children:' "llmExecutor"'},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:")"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#F97583"},children:"    public"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:" Executor "},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:"llmExecutor"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"() {"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#E1E4E8"},children:"        ThreadPoolExecutor executor "},void 0,!1,void 0,this),n("span",{style:{color:"#F97583"},children:"="},void 0,!1,void 0,this),n("span",{style:{color:"#F97583"},children:" new"},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:" ThreadPoolExecutor"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"("},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#79B8FF"},children:"                20"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:",                      "},void 0,!1,void 0,this),n("span",{style:{color:"#6A737D"},children:"// 核心线程数：根据 CPU 和内存调整"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#79B8FF"},children:"                50"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:",                      "},void 0,!1,void 0,this),n("span",{style:{color:"#6A737D"},children:"// 最大线程数"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#79B8FF"},children:"                60L"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:", TimeUnit.SECONDS,   "},void 0,!1,void 0,this),n("span",{style:{color:"#6A737D"},children:"// 空闲线程存活时间"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#F97583"},children:"                new"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:" LinkedBlockingQueue<>("},void 0,!1,void 0,this),n("span",{style:{color:"#79B8FF"},children:"1000"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"), "},void 0,!1,void 0,this),n("span",{style:{color:"#6A737D"},children:"// 等待队列"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#F97583"},children:"                new"},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:" ThreadFactoryBuilder"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"()."},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:"setNameFormat"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"("},void 0,!1,void 0,this),n("span",{style:{color:"#9ECBFF"},children:'"llm-task-%d"'},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:")."},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:"build"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"(),"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#F97583"},children:"                new"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:" ThreadPoolExecutor."},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:"CallerRunsPolicy"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"() "},void 0,!1,void 0,this),n("span",{style:{color:"#6A737D"},children:"// 拒绝策略：由调用者运行，减缓提交速度"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:n("span",{style:{color:"#E1E4E8"},children:"        );"},void 0,!1,void 0,this)},void 0,!1,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#F97583"},children:"        return"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:" executor;"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:n("span",{style:{color:"#E1E4E8"},children:"    }"},void 0,!1,void 0,this)},void 0,!1,void 0,this),`
`,n("span",{className:"line"},void 0,!1,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#E1E4E8"},children:"    @"},void 0,!1,void 0,this),n("span",{style:{color:"#F97583"},children:"Bean"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#F97583"},children:"    public"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:" CloseableHttpClient "},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:"httpClient"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"() {"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:n("span",{style:{color:"#6A737D"},children:"        // 配置连接池"},void 0,!1,void 0,this)},void 0,!1,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#E1E4E8"},children:"        PoolingHttpClientConnectionManager cm "},void 0,!1,void 0,this),n("span",{style:{color:"#F97583"},children:"="},void 0,!1,void 0,this),n("span",{style:{color:"#F97583"},children:" new"},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:" PoolingHttpClientConnectionManager"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"();"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#E1E4E8"},children:"        cm."},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:"setMaxTotal"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"("},void 0,!1,void 0,this),n("span",{style:{color:"#79B8FF"},children:"200"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:");"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#E1E4E8"},children:"        cm."},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:"setDefaultMaxPerRoute"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"("},void 0,!1,void 0,this),n("span",{style:{color:"#79B8FF"},children:"50"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:");"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line"},void 0,!1,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#F97583"},children:"        return"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:" HttpClients."},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:"custom"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"()"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#E1E4E8"},children:"                ."},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:"setConnectionManager"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"(cm)"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#E1E4E8"},children:"                ."},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:"setKeepAliveStrategy"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"(DefaultConnectionKeepAliveStrategy.INSTANCE)"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#E1E4E8"},children:"                ."},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:"build"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"();"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:n("span",{style:{color:"#E1E4E8"},children:"    }"},void 0,!1,void 0,this)},void 0,!1,void 0,this),`
`,n("span",{className:"line",children:n("span",{style:{color:"#E1E4E8"},children:"}"},void 0,!1,void 0,this)},void 0,!1,void 0,this),`
`,n("span",{className:"line"},void 0,!1,void 0,this),`
`,n("span",{className:"line"},void 0,!1,void 0,this)]},void 0,!0,void 0,this)},void 0,!1,void 0,this),`
`,n("h4",{children:"第二步：任务持久化与 SSE 流式处理服务"},void 0,!1,void 0,this),`
`,n("p",{children:"这是最核心的部分。我们使用 HttpClient 的流式响应来处理 SSE。"},void 0,!1,void 0,this),`
`,n("pre",{className:"shiki github-dark",style:{backgroundColor:"#24292e",color:"#e1e4e8"},tabIndex:"0",children:n("code",{children:[n("span",{className:"line",children:[n("span",{style:{color:"#E1E4E8"},children:"@"},void 0,!1,void 0,this),n("span",{style:{color:"#F97583"},children:"Service"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#F97583"},children:"public"},void 0,!1,void 0,this),n("span",{style:{color:"#F97583"},children:" class"},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:" LlmTaskService"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:" {"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line"},void 0,!1,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#E1E4E8"},children:"    @"},void 0,!1,void 0,this),n("span",{style:{color:"#F97583"},children:"Autowired"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#F97583"},children:"    private"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:" RedisTemplate<"},void 0,!1,void 0,this),n("span",{style:{color:"#F97583"},children:"String"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:", "},void 0,!1,void 0,this),n("span",{style:{color:"#F97583"},children:"Object"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"> redisTemplate;"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line"},void 0,!1,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#E1E4E8"},children:"    @"},void 0,!1,void 0,this),n("span",{style:{color:"#F97583"},children:"Autowired"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#E1E4E8"},children:"    @"},void 0,!1,void 0,this),n("span",{style:{color:"#F97583"},children:"Qualifier"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"("},void 0,!1,void 0,this),n("span",{style:{color:"#9ECBFF"},children:'"llmExecutor"'},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:")"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#F97583"},children:"    private"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:" Executor llmExecutor;"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line"},void 0,!1,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#E1E4E8"},children:"    @"},void 0,!1,void 0,this),n("span",{style:{color:"#F97583"},children:"Autowired"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#F97583"},children:"    private"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:" CloseableHttpClient httpClient;"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line"},void 0,!1,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#F97583"},children:"    private"},void 0,!1,void 0,this),n("span",{style:{color:"#F97583"},children:" static"},void 0,!1,void 0,this),n("span",{style:{color:"#F97583"},children:" final"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:" String TASK_KEY_PREFIX "},void 0,!1,void 0,this),n("span",{style:{color:"#F97583"},children:"="},void 0,!1,void 0,this),n("span",{style:{color:"#9ECBFF"},children:' "llm_task:"'},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:";"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line"},void 0,!1,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#F97583"},children:"    public"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:" String "},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:"createContextTask"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"(Map<"},void 0,!1,void 0,this),n("span",{style:{color:"#F97583"},children:"String"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:", "},void 0,!1,void 0,this),n("span",{style:{color:"#F97583"},children:"Object"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"> "},void 0,!1,void 0,this),n("span",{style:{color:"#FFAB70"},children:"params"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:") {"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#E1E4E8"},children:"        String taskId "},void 0,!1,void 0,this),n("span",{style:{color:"#F97583"},children:"="},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:" UUID."},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:"randomUUID"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"()."},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:"toString"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"();"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:n("span",{style:{color:"#E1E4E8"},children:"        "},void 0,!1,void 0,this)},void 0,!1,void 0,this),`
`,n("span",{className:"line",children:n("span",{style:{color:"#6A737D"},children:"        // 1. 初始化 Redis 状态"},void 0,!1,void 0,this)},void 0,!1,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#E1E4E8"},children:"        Map<"},void 0,!1,void 0,this),n("span",{style:{color:"#F97583"},children:"String"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:", "},void 0,!1,void 0,this),n("span",{style:{color:"#F97583"},children:"Object"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"> taskInfo "},void 0,!1,void 0,this),n("span",{style:{color:"#F97583"},children:"="},void 0,!1,void 0,this),n("span",{style:{color:"#F97583"},children:" new"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:" HashMap<>();"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#E1E4E8"},children:"        taskInfo."},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:"put"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"("},void 0,!1,void 0,this),n("span",{style:{color:"#9ECBFF"},children:'"status"'},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:", "},void 0,!1,void 0,this),n("span",{style:{color:"#9ECBFF"},children:'"RUNNING"'},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:");"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#E1E4E8"},children:"        taskInfo."},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:"put"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"("},void 0,!1,void 0,this),n("span",{style:{color:"#9ECBFF"},children:'"content"'},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:", "},void 0,!1,void 0,this),n("span",{style:{color:"#9ECBFF"},children:'""'},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"); "},void 0,!1,void 0,this),n("span",{style:{color:"#6A737D"},children:"// 用于存放增量结果"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#E1E4E8"},children:"        taskInfo."},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:"put"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"("},void 0,!1,void 0,this),n("span",{style:{color:"#9ECBFF"},children:'"startTime"'},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:", System."},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:"currentTimeMillis"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"());"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#E1E4E8"},children:"        redisTemplate."},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:"opsForHash"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"()."},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:"putAll"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"(TASK_KEY_PREFIX "},void 0,!1,void 0,this),n("span",{style:{color:"#F97583"},children:"+"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:" taskId, taskInfo);"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:n("span",{style:{color:"#6A737D"},children:"        // 设置 24 小时过期，防止 Redis 堆积"},void 0,!1,void 0,this)},void 0,!1,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#E1E4E8"},children:"        redisTemplate."},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:"expire"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"(TASK_KEY_PREFIX "},void 0,!1,void 0,this),n("span",{style:{color:"#F97583"},children:"+"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:" taskId, "},void 0,!1,void 0,this),n("span",{style:{color:"#79B8FF"},children:"24"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:", TimeUnit.HOURS);"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line"},void 0,!1,void 0,this),`
`,n("span",{className:"line",children:n("span",{style:{color:"#6A737D"},children:"        // 2. 异步执行"},void 0,!1,void 0,this)},void 0,!1,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#E1E4E8"},children:"        llmExecutor."},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:"execute"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"(() "},void 0,!1,void 0,this),n("span",{style:{color:"#F97583"},children:"->"},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:" executeLlmCall"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"(taskId, params));"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line"},void 0,!1,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#F97583"},children:"        return"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:" taskId;"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:n("span",{style:{color:"#E1E4E8"},children:"    }"},void 0,!1,void 0,this)},void 0,!1,void 0,this),`
`,n("span",{className:"line"},void 0,!1,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#F97583"},children:"    private"},void 0,!1,void 0,this),n("span",{style:{color:"#F97583"},children:" void"},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:" executeLlmCall"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"(String "},void 0,!1,void 0,this),n("span",{style:{color:"#FFAB70"},children:"taskId"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:", Map<"},void 0,!1,void 0,this),n("span",{style:{color:"#F97583"},children:"String"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:", "},void 0,!1,void 0,this),n("span",{style:{color:"#F97583"},children:"Object"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"> "},void 0,!1,void 0,this),n("span",{style:{color:"#FFAB70"},children:"params"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:") {"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#E1E4E8"},children:"        String redisKey "},void 0,!1,void 0,this),n("span",{style:{color:"#F97583"},children:"="},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:" TASK_KEY_PREFIX "},void 0,!1,void 0,this),n("span",{style:{color:"#F97583"},children:"+"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:" taskId;"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#E1E4E8"},children:"        HttpPost httpPost "},void 0,!1,void 0,this),n("span",{style:{color:"#F97583"},children:"="},void 0,!1,void 0,this),n("span",{style:{color:"#F97583"},children:" new"},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:" HttpPost"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"("},void 0,!1,void 0,this),n("span",{style:{color:"#9ECBFF"},children:'"https://llm-service.com/v1/chat/completions"'},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:");"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:n("span",{style:{color:"#E1E4E8"},children:"        "},void 0,!1,void 0,this)},void 0,!1,void 0,this),`
`,n("span",{className:"line",children:n("span",{style:{color:"#6A737D"},children:"        // 设置超时：注意这里要设为 20 分钟以上"},void 0,!1,void 0,this)},void 0,!1,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#E1E4E8"},children:"        RequestConfig requestConfig "},void 0,!1,void 0,this),n("span",{style:{color:"#F97583"},children:"="},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:" RequestConfig."},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:"custom"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"()"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#E1E4E8"},children:"                ."},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:"setConnectTimeout"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"("},void 0,!1,void 0,this),n("span",{style:{color:"#79B8FF"},children:"5000"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:")"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#E1E4E8"},children:"                ."},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:"setSocketTimeout"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"("},void 0,!1,void 0,this),n("span",{style:{color:"#79B8FF"},children:"25"},void 0,!1,void 0,this),n("span",{style:{color:"#F97583"},children:" *"},void 0,!1,void 0,this),n("span",{style:{color:"#79B8FF"},children:" 60"},void 0,!1,void 0,this),n("span",{style:{color:"#F97583"},children:" *"},void 0,!1,void 0,this),n("span",{style:{color:"#79B8FF"},children:" 1000"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:") "},void 0,!1,void 0,this),n("span",{style:{color:"#6A737D"},children:"// 25分钟"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#E1E4E8"},children:"                ."},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:"build"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"();"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#E1E4E8"},children:"        httpPost."},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:"setConfig"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"(requestConfig);"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:n("span",{style:{color:"#E1E4E8"},children:"        "},void 0,!1,void 0,this)},void 0,!1,void 0,this),`
`,n("span",{className:"line",children:n("span",{style:{color:"#6A737D"},children:"        // 设置 SSE 必要的 Header"},void 0,!1,void 0,this)},void 0,!1,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#E1E4E8"},children:"        httpPost."},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:"addHeader"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"("},void 0,!1,void 0,this),n("span",{style:{color:"#9ECBFF"},children:'"Accept"'},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:", "},void 0,!1,void 0,this),n("span",{style:{color:"#9ECBFF"},children:'"text/event-stream"'},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:");"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:n("span",{style:{color:"#6A737D"},children:"        // 设置 Body (略)"},void 0,!1,void 0,this)},void 0,!1,void 0,this),`
`,n("span",{className:"line"},void 0,!1,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#F97583"},children:"        try"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:" (CloseableHttpResponse response "},void 0,!1,void 0,this),n("span",{style:{color:"#F97583"},children:"="},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:" httpClient."},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:"execute"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"(httpPost)) {"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#E1E4E8"},children:"            HttpEntity entity "},void 0,!1,void 0,this),n("span",{style:{color:"#F97583"},children:"="},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:" response."},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:"getEntity"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"();"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#F97583"},children:"            if"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:" (entity "},void 0,!1,void 0,this),n("span",{style:{color:"#F97583"},children:"!="},void 0,!1,void 0,this),n("span",{style:{color:"#79B8FF"},children:" null"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:") {"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#F97583"},children:"                try"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:" (BufferedReader reader "},void 0,!1,void 0,this),n("span",{style:{color:"#F97583"},children:"="},void 0,!1,void 0,this),n("span",{style:{color:"#F97583"},children:" new"},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:" BufferedReader"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"("},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#F97583"},children:"                        new"},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:" InputStreamReader"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"(entity."},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:"getContent"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"(), StandardCharsets.UTF_8))) {"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:n("span",{style:{color:"#E1E4E8"},children:"                    String line;"},void 0,!1,void 0,this)},void 0,!1,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#F97583"},children:"                    while"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:" ((line "},void 0,!1,void 0,this),n("span",{style:{color:"#F97583"},children:"="},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:" reader."},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:"readLine"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"()) "},void 0,!1,void 0,this),n("span",{style:{color:"#F97583"},children:"!="},void 0,!1,void 0,this),n("span",{style:{color:"#79B8FF"},children:" null"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:") {"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:n("span",{style:{color:"#6A737D"},children:"                        // SSE 协议解析逻辑"},void 0,!1,void 0,this)},void 0,!1,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#F97583"},children:"                        if"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:" (line."},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:"startsWith"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"("},void 0,!1,void 0,this),n("span",{style:{color:"#9ECBFF"},children:'"data:"'},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:")) {"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#E1E4E8"},children:"                            String data "},void 0,!1,void 0,this),n("span",{style:{color:"#F97583"},children:"="},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:" line."},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:"substring"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"("},void 0,!1,void 0,this),n("span",{style:{color:"#79B8FF"},children:"5"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:")."},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:"trim"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"();"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#F97583"},children:"                            if"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:" ("},void 0,!1,void 0,this),n("span",{style:{color:"#9ECBFF"},children:'"[DONE]"'},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"."},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:"equals"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"(data)) "},void 0,!1,void 0,this),n("span",{style:{color:"#F97583"},children:"break"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:";"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line"},void 0,!1,void 0,this),`
`,n("span",{className:"line",children:n("span",{style:{color:"#6A737D"},children:"                            // 解析 JSON 提取文本内容 (模拟解析)"},void 0,!1,void 0,this)},void 0,!1,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#E1E4E8"},children:"                            String contentChunk "},void 0,!1,void 0,this),n("span",{style:{color:"#F97583"},children:"="},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:" parseContent"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"(data); "},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:n("span",{style:{color:"#E1E4E8"},children:"                            "},void 0,!1,void 0,this)},void 0,!1,void 0,this),`
`,n("span",{className:"line",children:n("span",{style:{color:"#6A737D"},children:"                            // 实时追加到 Redis，前端轮询能看到动态增长的内容"},void 0,!1,void 0,this)},void 0,!1,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#E1E4E8"},children:"                            redisTemplate."},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:"opsForHash"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"()."},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:"increment"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"(redisKey, "},void 0,!1,void 0,this),n("span",{style:{color:"#9ECBFF"},children:'"content"'},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:", contentChunk);"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:n("span",{style:{color:"#E1E4E8"},children:"                        }"},void 0,!1,void 0,this)},void 0,!1,void 0,this),`
`,n("span",{className:"line",children:n("span",{style:{color:"#E1E4E8"},children:"                    }"},void 0,!1,void 0,this)},void 0,!1,void 0,this),`
`,n("span",{className:"line",children:n("span",{style:{color:"#E1E4E8"},children:"                }"},void 0,!1,void 0,this)},void 0,!1,void 0,this),`
`,n("span",{className:"line",children:n("span",{style:{color:"#E1E4E8"},children:"            }"},void 0,!1,void 0,this)},void 0,!1,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#E1E4E8"},children:"            redisTemplate."},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:"opsForHash"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"()."},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:"put"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"(redisKey, "},void 0,!1,void 0,this),n("span",{style:{color:"#9ECBFF"},children:'"status"'},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:", "},void 0,!1,void 0,this),n("span",{style:{color:"#9ECBFF"},children:'"SUCCESS"'},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:");"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#E1E4E8"},children:"        } "},void 0,!1,void 0,this),n("span",{style:{color:"#F97583"},children:"catch"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:" (Exception "},void 0,!1,void 0,this),n("span",{style:{color:"#FFAB70"},children:"e"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:") {"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#E1E4E8"},children:"            redisTemplate."},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:"opsForHash"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"()."},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:"put"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"(redisKey, "},void 0,!1,void 0,this),n("span",{style:{color:"#9ECBFF"},children:'"status"'},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:", "},void 0,!1,void 0,this),n("span",{style:{color:"#9ECBFF"},children:'"FAILED"'},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:");"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#E1E4E8"},children:"            redisTemplate."},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:"opsForHash"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"()."},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:"put"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"(redisKey, "},void 0,!1,void 0,this),n("span",{style:{color:"#9ECBFF"},children:'"error"'},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:", e."},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:"getMessage"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"());"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:n("span",{style:{color:"#E1E4E8"},children:"        }"},void 0,!1,void 0,this)},void 0,!1,void 0,this),`
`,n("span",{className:"line",children:n("span",{style:{color:"#E1E4E8"},children:"    }"},void 0,!1,void 0,this)},void 0,!1,void 0,this),`
`,n("span",{className:"line"},void 0,!1,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#F97583"},children:"    public"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:" Map<"},void 0,!1,void 0,this),n("span",{style:{color:"#F97583"},children:"Object"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:", "},void 0,!1,void 0,this),n("span",{style:{color:"#F97583"},children:"Object"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"> "},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:"getTaskStatus"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"(String "},void 0,!1,void 0,this),n("span",{style:{color:"#FFAB70"},children:"taskId"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:") {"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#F97583"},children:"        return"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:" redisTemplate."},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:"opsForHash"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"()."},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:"entries"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"(TASK_KEY_PREFIX "},void 0,!1,void 0,this),n("span",{style:{color:"#F97583"},children:"+"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:" taskId);"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:n("span",{style:{color:"#E1E4E8"},children:"    }"},void 0,!1,void 0,this)},void 0,!1,void 0,this),`
`,n("span",{className:"line",children:n("span",{style:{color:"#E1E4E8"},children:"}"},void 0,!1,void 0,this)},void 0,!1,void 0,this),`
`,n("span",{className:"line"},void 0,!1,void 0,this),`
`,n("span",{className:"line"},void 0,!1,void 0,this)]},void 0,!0,void 0,this)},void 0,!1,void 0,this),`
`,n("hr",{},void 0,!1,void 0,this),`
`,n("h3",{children:"3. 高级架构点评与细节优化"},void 0,!1,void 0,this),`
`,n("p",{children:["基于你的方案和我的调整，现在的架构达到了",n("strong",{children:"工业级可用"},void 0,!1,void 0,this),"，原因如下："]},void 0,!0,void 0,this),`
`,n("h4",{children:"1. 内存压力最小化"},void 0,!1,void 0,this),`
`,n("ul",{children:[`
`,n("li",{children:[n("strong",{children:"非 SSE 方案"},void 0,!1,void 0,this),"：如果等待 20 分钟一次性返回，Java 需要在内存里 Hold 住巨大的字符串对象，直到任务结束。"]},void 0,!0,void 0,this),`
`,n("li",{children:[n("strong",{children:"本方案 (SSE + 流处理)"},void 0,!1,void 0,this),"：通过 ",n("code",{children:"BufferedReader.readLine()"},void 0,!1,void 0,this),"，Java 服务内存中只保留当前一行的数据。解析后立即存入 Redis，不再占用 JVM 堆空间。"]},void 0,!0,void 0,this),`
`]},void 0,!0,void 0,this),`
`,n("h4",{children:"2. 线程安全性与可靠性"},void 0,!1,void 0,this),`
`,n("ul",{children:[`
`,n("li",{children:[n("strong",{children:"线程池限流"},void 0,!1,void 0,this),"：通过 ",n("code",{children:"ThreadPoolExecutor"},void 0,!1,void 0,this)," 的 ",n("code",{children:"maxPoolSize"},void 0,!1,void 0,this)," 限制了最大并发请求数。即使有 1 万个用户请求，也只有 50 个在跑，剩下的在队列里。这保护了你的后端不会因为线程过多而导致 OOM。"]},void 0,!0,void 0,this),`
`,n("li",{children:[n("strong",{children:"Redis 状态机"},void 0,!1,void 0,this),"：即便你的 Java 服务因为发布而重启，Redis 里的 ",n("code",{children:"taskId"},void 0,!1,void 0,this)," 和已有的 ",n("code",{children:"content"},void 0,!1,void 0,this)," 依然存在。你可以增加一个“补偿机制”：服务启动时扫描 Redis 中 ",n("code",{children:"RUNNING"},void 0,!1,void 0,this)," 的任务，将其置为 ",n("code",{children:"FAILED"},void 0,!1,void 0,this)," 或尝试重试。"]},void 0,!0,void 0,this),`
`]},void 0,!0,void 0,this),`
`,n("h4",{children:"3. 解决长连接断连问题"},void 0,!1,void 0,this),`
`,n("ul",{children:[`
`,n("li",{children:[n("strong",{children:"HttpClient 4 注意事项"},void 0,!1,void 0,this),"：20 分钟的连接非常脆弱。一定要确保 ",n("code",{children:"SocketTimeout"},void 0,!1,void 0,this)," 足够长。"]},void 0,!0,void 0,this),`
`,n("li",{children:[n("strong",{children:"TCP Keep-Alive"},void 0,!1,void 0,this),"：建议在操作系统或 HttpClient 层面开启 Keep-Alive，防止中间层网关（如 F5 或 Nginx）因为长时间没有数据传输而强制切断连接。"]},void 0,!0,void 0,this),`
`]},void 0,!0,void 0,this),`
`,n("h4",{children:"4. 前端轮询体验"},void 0,!1,void 0,this),`
`,n("ul",{children:[`
`,n("li",{children:[n("strong",{children:"增量查询"},void 0,!1,void 0,this),"：前端轮询时，你可以记录上一次查询到的字符位置，下次只查询 Redis 中新增的部分，实现类似 ChatGPT 的动态打字效果。"]},void 0,!0,void 0,this),`
`]},void 0,!0,void 0,this),`
`,n("h3",{children:"总结"},void 0,!1,void 0,this),`
`,n("p",{children:["你原来的方案在“异步化”思路上是正确的，引入 ",n("strong",{children:"Redis 持久化"},void 0,!1,void 0,this),"解决了“状态不可控”问题，引入 ",n("strong",{children:"线程池"},void 0,!1,void 0,this),"解决了“资源爆炸”问题，引入 ",n("strong",{children:"SSE 流式解析"},void 0,!1,void 0,this),"解决了“长耗时任务内存占用”问题。这是一个非常稳妥且高性能的生产环境方案。"]},void 0,!0,void 0,this)]},void 0,!0,void 0,this)},void 0,!1,void 0,this)}export{s as default};
