import{e as a,h as n}from"/dist/chunk-scq2q67j.js";function p(){return n("div",{class:"markdown-body",children:n(a,{children:[n("h1",{children:"nodejs 上实现 AES 解密实现"},void 0,!1,void 0,this),`
`,n("p",{children:"这篇文章只有解密部分，原因是业务上的需求是使用 Java 实现了 AES 加密、解密工具，需要使用 nodejs 实现相应的解密功能。"},void 0,!1,void 0,this),`
`,n("h2",{children:"算法选择"},void 0,!1,void 0,this),`
`,n("p",{children:["密钥使用 ",n("code",{children:"PBKDF2WithHmacSHA256"},void 0,!1,void 0,this)," 算法进行派生。"]},void 0,!0,void 0,this),`
`,n("p",{children:["加密使用 AES 算法，GCM 模式，补码为 NoPadding。在 Java 一般写为 ",n("code",{children:"AES/GCM/NoPadding"},void 0,!1,void 0,this),"。"]},void 0,!0,void 0,this),`
`,n("h2",{children:"工作流程"},void 0,!1,void 0,this),`
`,n("p",{children:"加密的算法是公开的，但是如何去使用这些算法进行数据处理则属于各个项目的设计问题。通过不同的工作流程，可以增加安全性。"},void 0,!1,void 0,this),`
`,n("p",{children:"比如这样的一个流程："},void 0,!1,void 0,this),`
`,n("p",{children:n("img",{src:"/images/aes-decrypt-workflow.svg",alt:"AES 解密流程"},void 0,!1,void 0,this)},void 0,!1,void 0,this),`
`,n("p",{children:"AES 解密是需要密码明文，需要设计一个流程用于获取密码明文，直接将密码的明文放到系统中就增加了泄密的风险。比如上面的流程就使用了二次解密的方法。"},void 0,!1,void 0,this),`
`,n("p",{children:["根据 PBKDF2 算法的特点，在使用相同初始数据的情况，PBKDF2 算法可以得到相同的密钥，可以将这个密钥称为",n("strong",{children:"根密钥"},void 0,!1,void 0,this),`。用根密钥将工作数据加密用的
密码明文进行加密，就可以得到`,n("strong",{children:"工作密钥的密文"},void 0,!1,void 0,this),"。"]},void 0,!0,void 0,this),`
`,n("p",{children:["使用时，先在应用中配置相应的",n("strong",{children:"密钥因子"},void 0,!1,void 0,this),"、",n("strong",{children:"初始向量"},void 0,!1,void 0,this),"和",n("strong",{children:"工作密钥的密文"},void 0,!1,void 0,this),`。所谓初始向量实际是一段由安全随机数生成的随机字节数据。
通过密钥因子和初始向量，生成根密钥；然后用根密钥、初始向量将工作密钥密文进行解密，得到工作密钥明文；然后用工作密钥明文对数据密文进行解密。
这样就可以得到数据的原文。`]},void 0,!0,void 0,this),`
`,n("p",{children:`通过上面的设计，数据密文解密的影响因子起码增加了 3 个，而且有了一个更为复杂的流程。就是攻击者需要同时得到这面三个因子和具体的流程才可以成功解密
出敏感数据，无疑是增加了破解的难度。`},void 0,!1,void 0,this),`
`,n("h2",{children:"代码"},void 0,!1,void 0,this),`
`,n("p",{children:"这里就不贴上完整的代码，只有关键步骤的代码，具体按流程一步一步实现即可。"},void 0,!1,void 0,this),`
`,n("h3",{children:"pbkdf2 密钥派生"},void 0,!1,void 0,this),`
`,n("p",{children:"crypto 模块自带 pbkdf2 算法实现，而且 hash 算法只支持 hmac 族的各种 hash，比如上面的 sha256。"},void 0,!1,void 0,this),`
`,n("pre",{className:"shiki github-dark",style:{backgroundColor:"#24292e",color:"#e1e4e8"},tabIndex:"0",children:n("code",{className:"language-js",children:[n("span",{className:"line",children:[n("span",{style:{color:"#F97583"},children:"const"},void 0,!1,void 0,this),n("span",{style:{color:"#79B8FF"},children:" crypto"},void 0,!1,void 0,this),n("span",{style:{color:"#F97583"},children:" ="},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:" require"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"("},void 0,!1,void 0,this),n("span",{style:{color:"#9ECBFF"},children:"'crypto'"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:");"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line"},void 0,!1,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#F97583"},children:"function"},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:" getUtf8Bytes"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"("},void 0,!1,void 0,this),n("span",{style:{color:"#FFAB70"},children:"str"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:") {"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#F97583"},children:"  return"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:" Buffer."},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:"from"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"(str, "},void 0,!1,void 0,this),n("span",{style:{color:"#9ECBFF"},children:"'utf-8'"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:");"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:n("span",{style:{color:"#E1E4E8"},children:"}"},void 0,!1,void 0,this)},void 0,!1,void 0,this),`
`,n("span",{className:"line"},void 0,!1,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#F97583"},children:"function"},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:" getKey"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"("},void 0,!1,void 0,this),n("span",{style:{color:"#FFAB70"},children:"password"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:", "},void 0,!1,void 0,this),n("span",{style:{color:"#FFAB70"},children:"salt"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:") {"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#F97583"},children:"  return"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:" crypto."},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:"pbkdf2Sync"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"("},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:"getUtf8Bytes"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"(password), "},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:"getUtf8Bytes"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"(salt), "},void 0,!1,void 0,this),n("span",{style:{color:"#79B8FF"},children:"10000"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:", "},void 0,!1,void 0,this),n("span",{style:{color:"#79B8FF"},children:"KEY_LEN_IN_BYTES"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:", "},void 0,!1,void 0,this),n("span",{style:{color:"#9ECBFF"},children:"'sha256'"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:");"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:n("span",{style:{color:"#E1E4E8"},children:"}"},void 0,!1,void 0,this)},void 0,!1,void 0,this)]},void 0,!0,void 0,this)},void 0,!1,void 0,this),`
`,n("h3",{children:"AES/GCM/NoPadding"},void 0,!1,void 0,this),`
`,n("p",{children:["nodejs 的 crypto 模块是基于 OpenSSL 封装的模块，基本上使用了 OpenSSL 的领域名词。比如 128 位 AES 算法叫 ",n("code",{children:"id-aes128-gcm"},void 0,!1,void 0,this),` 等。
对于 AES 算法的 GCM 模式，本身是对补码没有相应要求的。因此 Java 中的 `,n("code",{children:"AES/GCM/NoPadding"},void 0,!1,void 0,this)," 可以使用 ",n("code",{children:"id-aes128-gcm"},void 0,!1,void 0,this),` 的兼容处理。
按密钥的长度，可以使用不同位数的 AES 算法。比如长度为 16 字节的密钥，可以使用 `,n("code",{children:"id-aes128-gcm"},void 0,!1,void 0,this),"；长度为 32 字节的密钥，应该使用 ",n("code",{children:"id-aes256-gcm"},void 0,!1,void 0,this),` 进行
处理。`]},void 0,!0,void 0,this),`
`,n("p",{children:"另外 AES 解密时有一个 AuthTag 的问题需要处理。"},void 0,!1,void 0,this),`
`,n("pre",{className:"shiki github-dark",style:{backgroundColor:"#24292e",color:"#e1e4e8"},tabIndex:"0",children:n("code",{className:"language-js",children:[n("span",{className:"line",children:[n("span",{style:{color:"#F97583"},children:"function"},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:" decrypt"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"("},void 0,!1,void 0,this),n("span",{style:{color:"#FFAB70"},children:"contentBytes"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:", "},void 0,!1,void 0,this),n("span",{style:{color:"#FFAB70"},children:"key"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:") {"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#F97583"},children:"  const"},void 0,!1,void 0,this),n("span",{style:{color:"#79B8FF"},children:" decipher"},void 0,!1,void 0,this),n("span",{style:{color:"#F97583"},children:" ="},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:" crypto."},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:"createDecipheriv"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"("},void 0,!1,void 0,this),n("span",{style:{color:"#9ECBFF"},children:"'id-aes128-gcm'"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:", key, "},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:"getUtf8Bytes"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"(iv));"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#E1E4E8"},children:"  decipher."},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:"setAuthTag"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"(contentBytes."},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:"slice"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"(contentBytes.byteLength "},void 0,!1,void 0,this),n("span",{style:{color:"#F97583"},children:"-"},void 0,!1,void 0,this),n("span",{style:{color:"#79B8FF"},children:" 16"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"));"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line"},void 0,!1,void 0,this),`
`,n("span",{className:"line",children:[n("span",{style:{color:"#F97583"},children:"  return"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:" decipher."},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:"update"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"(contentBytes."},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:"slice"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"("},void 0,!1,void 0,this),n("span",{style:{color:"#79B8FF"},children:"0"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:", contentBytes.byteLength "},void 0,!1,void 0,this),n("span",{style:{color:"#F97583"},children:"-"},void 0,!1,void 0,this),n("span",{style:{color:"#79B8FF"},children:" 16"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"), "},void 0,!1,void 0,this),n("span",{style:{color:"#79B8FF"},children:"null"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:", "},void 0,!1,void 0,this),n("span",{style:{color:"#9ECBFF"},children:"'utf-8'"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:") "},void 0,!1,void 0,this),n("span",{style:{color:"#F97583"},children:"+"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:" decipher."},void 0,!1,void 0,this),n("span",{style:{color:"#B392F0"},children:"final"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:"("},void 0,!1,void 0,this),n("span",{style:{color:"#9ECBFF"},children:"'utf-8'"},void 0,!1,void 0,this),n("span",{style:{color:"#E1E4E8"},children:");"},void 0,!1,void 0,this)]},void 0,!0,void 0,this),`
`,n("span",{className:"line",children:n("span",{style:{color:"#E1E4E8"},children:"}"},void 0,!1,void 0,this)},void 0,!1,void 0,this)]},void 0,!0,void 0,this)},void 0,!1,void 0,this),`
`,n("hr",{},void 0,!1,void 0,this),`
`,n("p",{children:"2021 年 12 月 01 日"},void 0,!1,void 0,this)]},void 0,!0,void 0,this)},void 0,!1,void 0,this)}export{p as default};
