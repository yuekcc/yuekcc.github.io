# zig

最近在学习 Zig。Zig 是一种号称要代替 C 的编程语言。

最初在一些科技新闻类网站看到 Zig 的介绍时，其实我不以为然。因为想要代替 C 的语言太多了，而且大多数是口号响亮努力太少。直到 Bun 出现。

Bun 是 Zig + Webkit + JavaScriptCore 的全新 JavaScript 运行环境，性能可谓是比 Nodejs 强大很多。虽然有点宣传过头的味道，但 Bun 确实每一个版本都在改进。Bun 另一个特点是试图兼容 Node.js 的生态。Deno 是另一个 JavaScript 运行环境。Deno 本来是打着推翻 Node.js 口号而来的。可能因为 Bun 的出现吧，Deno 也加速开发并很快就推出了 NPM 包兼容模式。

Bun 大概是 Zig 第一次产品级的应用吧。此时 Zig 还是 0.9.1。也因为 Bun 的出现吧，我也开始去了解 Zig。

## Zig 实际上是什么

虽然 Zig 号称要代替 C。但是 Zig 本身就是从 C 发展而来，主要就是解决 C 的问题。

C 是一门很小巧的语言，接近底层，应用广泛。早年在学习编程的时候，我也入门过 C。Zig 作者认为 C 有三个最大的问题：1、C 编译器实现有太多魔法；2、C 的预处理器和 C 本身实际上没有关系，是两种不同的语言而且无法交互；3、使用 C 编写软件，还需要学习大量 C 无关的东西，比如编译系统等。Zig 就试图解决这些问题。

C 编译器的魔法主要就是 C 标准中包含大量 undefined 行为。这些内容由 C 编译器厂商各自发挥。这里面当然是充满各种黑魔法硬编码。最典型就是 Zig 作者提及的 printf 格式错误问题，基本上是硬编码。Zig 的做法是通过编译期执行开放编译器的能力到用户代码，减少编译器的硬编码。

C 的预处理器实际上是一个模板工具，负责生成代码。C 的预处理器使用自己的语法。因为是一个代码生成工具，当然不会与 C 代码交互。生成器没有解释 C 代码的能力。Zig 的解决方案就是在编译器内部实现了一个 Zig 解释器，在编译期可以执行 Zig 代码。这不完全是 Zig 的原创特性，有人说 Lisp 也有相近的能力。得益于 Zig 能够边编译边执行代码，Zig 相当于实现了一套宏系统，而且可以和任意 Zig 代码交互。通过这个能力，Zig 也实现了一套编译期泛型系统。

C 编译工具也是各种各样。比如 cmake、autoconf 之类。每个工具都各自实现，使用不同的语法，为了不同的目标而创建出来。但是这些工具的目的都是为了编译 C 代码。结果就是每个 C 工程，因为作者的喜爱，使用不同的编译工具，而且这些工具之间又不兼容。C 工程之间共享代码基本上只能使用 copy 代码或 library 的方式。Zig 则通过内置 Zig build system 来尝试解决这个问题。

## Zig 还有什么有趣的特性

defer、Option 类型、Error Set、基于 Status 模块系统、@aaaBBB 内置函数、if/for/while/switch 表达式、type 类型、async/await。这些都是比较有趣的功能。一门现代语言（2000 后出现）有的很多特性，Zig 都有提供。细心对比一下，就会发布 Zig 的这些功能确实是围绕 C 的痛点展开的。我相关喜欢 C 的人也会喜欢 Zig。

Zig 是一种需要手工管理内存的功能。defer 算是唯一可以帮助内存管理的设施。实际上手能内存管理的代码相当无聊。Rust 是基于所有权、类型系统实现的一套半自动内存管理模型。但是尝试过 Rust 之后，Rust 这种半自动的内存管理在体验上不输 JavaScript。Rust 的内存释放实际上编译器在编译时在一个对象的生命周期结束时自动插入 drop 函数实现的。相当于原来需要人工编写的 drop 语句，改为编译期自动插入了。这些对比下来，Zig 的内存管理可谓原始。

我使用 Zig 实现了一个 Git 插件。Zig 内存管理语句确实比较干扰，打断正常的业务流程。有一种 Go Error 处理的即视感。我想换为 C 语言也差不多是这样吧。

Zig 没有全局的内存分配器。官方推荐的写法是将内存分配器作为参数，传入函数或 Struct。在习惯这种写法之后，内存分配器的参数化确实比使用全局的分配器更为直观。我尝试将我 Git 插件改为全局内存分配器，虽然减少了几个参数，但是释放内存只能先看看源码，再作为决定。

Zig cc 也是 Zig 提供的一个工具。Zig 本身使用了 llvm，而且 Zig 为了编译 C 代码也集成了 clang。Zig cc 就是其内部 clang 的一个入口。比较有趣的是 Zig cc 实现的缓存功能，比 clang 更好的编译性能，而且通过集成 C headers，可以很方便地实现跨平台编译。Zig cc 也可以驱动 Rust、Nim 编译。即使 Zig 语言本身小众，但是作为为 C 编译工具也有市场。

## Zig vs Rust

现在任何一门语言对比，都不可能绕开 Rust 了。Rust 也是 2000 后出现的现代语言。如果 Zig 是更好的 C，那么 Rust 大概就是正确的 C++。

Rust 的生态现在算是发展起来了，不断有公司使用 Rust 实现产品级软件。Rust 也成功加入 Linux 内核的开发工具链。相信 Rust 会取代 Go、C/C+ 很多的位置。Rust 也可以和 Nodejs、Python 配合使用，为这些语言实现原生模板。

Rust 有面向高性能编程、高安全性编程的目标。这些和 Zig 是高度重合。所以有人认为 Zig 是小一号的 Rust。目前 Zig 对比 Rust 最大的优势是 Zig 有非常快的编译速度、很好的性能、与 C 代码集成更方便。Rust 的编译速度实现太感人，Rust 整个编译流程更接近 C++ 而且 Rust 的宏也是另一门语言。

语言方面，Rust 更加函数式，Zig 则比较传统。有意思的是两者的 Struct 对象都不支持嵌套。Zig、Rust 现在都已经实现自举。Zig 0.11.dev 的自举比较创新，引入了 WASM 技术来实现多平台的自举支持。

## 后续

现在我最喜欢的语言依次是 JavaScript、Zig、Rust。Zig 还在发展中，计划 2025 年能实现 1.0。保持关注，可能有惊喜。

---

- 2022-12-27
